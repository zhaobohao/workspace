# 正流程

##处理范围及发起时点

针对单笔交易，由查证流程发起

针对单笔交易，由外系统发起

针对批量交易，由外系统发起

针对批量交易，由Schedule发起

##处理流程

* 若为初次进入，则将交易置处理中，从头开始正流程。若不是，则检查最后一次成功的步骤，从断点处继续正流程。
* 步骤成功，记录步骤成功。继续正流程。
* 步骤失败，记录步骤失败。进入冲正流程。
* 步骤超时，记录步骤存疑。进入查证流程。
* 所有步骤成功后，交易置为成功。返回结果
* 存在步骤失败的情况，返回失败
* 存在步骤存疑的情况，若请求方接受，返回存疑，若请求方不接受，建议返回失败。


# 查证流程
##处理范围及发起时点
* 针对单笔交易，由主流程发起

* 针对批量交易，由Schedule发起

##处理流程
* 是否正在归档，如果是则结束此次查证

* 进行查证。只有在服务方明确找到相应记录，并返回成功、失败或存疑时，才算获得了结果。查无记录，并不能代表获取到了结果。如果查证超时，视作存疑。

* 针对存疑记录，需要设立一个条件，以使其转换为成功、失败，避免陷入不断的查询当中。条件可以是满足一定的查证次数，或是已经过最后期限的交易。

* 若查无记录，记录查证次数。比较累计次数与阈值的大小。若小于阈值则不再处理，超过阈值则视作失败。阈值可以是1.

* 根据查证结果的成功或失败，更新调用结果

* 如果成功，则根据场景选择，继续正流程，或开始冲正流程。对于正流程中返回失败给冲正流程。

* 如果失败，则进入冲正流程。


# 冲正流程
## 处理范围及发起时点
* 针对单笔交易，由查证流程发起

* 针对单笔交易，由正流程发起

* 针对单笔交易，由外系统发起

* 针对批量交易，由外系统发起

* 针对批量交易，由Schedule发起

##处理流程
* 修改交易状态为冲正中

* 从最后一步调用成功的位置开始，逆着正流程，逐步冲正。

* 若冲正返回已冲正或冲正成功。则继续冲正步骤，全部冲正成功，交易置为失败。

* 若冲正返回失败或是超时，则记录当前调用的冲正次数。比较累计次数与阈值的大小，若小于阈值则不再处理，超过阈值则转入人工处理，并将交易置为人工处理。阈值可以是1。


